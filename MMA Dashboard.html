<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>MMA Fights Time Series Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: steelblue;
      shape-rendering: crispEdges;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 2px;
    }

    .year-fights-info {
      font-size: 20px;
      font-weight: bold;
      text-anchor: middle;
    }

    .chart {
      display: inline-block;
      margin: 20px;
    }

    .country {
      fill: #add8e6;
      stroke: #ffffff;
      stroke-width: 1px;
    }

    .bubble {
      fill: red;
      stroke: black;
      stroke-width: 1;
      opacity: 0.6;
    }

    .tooltip {
      position: absolute;
      text-align: center;
      width: auto;
      height: auto;
      padding: 4px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
      opacity: 0;
    }
  </style>
</head>

<body>
  <script type="text/javascript">
    d3.csv("mmaData.csv", function (error, data) {
      if (error) throw error;

      data.forEach(function (d) {
        var parser = d3.time.format("%d/%m/%Y").parse;
        d['date'] = parser(d['date']);
      });

      console.log("First 5 rows: ", data.slice(0, 5));

    });

    //Code for animated line chart
    function drawTimeSeries(data) {

      var fightsByYear = d3.nest()
        .key(function (d) { return d['date'].getFullYear(); })
        .rollup(function (v) { return v.length; })
        .entries(data);

      var margin = { top: 20, right: 20, bottom: 30, left: 50 },
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      var x = d3.time.scale()
        .range([0, width])
        .domain(d3.extent(fightsByYear, function (d) { return new Date(d.key, 0, 1); }));

      var y = d3.scale.linear()
        .range([height, 0])
        .domain([0, d3.max(fightsByYear, function (d) { return d.values; })]);

      var xAxis = d3.svg.axis().scale(x).orient("bottom");
      var yAxis = d3.svg.axis().scale(y).orient("left");

      var line = d3.svg.line()
        .x(function (d) { return x(new Date(d.key, 0, 1)); })
        .y(function (d) { return y(d.values); });

      var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      svg.append("text")
        .attr("x", width / 2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .style("font-size", "24px")
        .text("Number of fights over the years");

      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

      svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

        svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", width)
        .attr("y", height + margin.top + 5)
        .text("Year");

      svg.append("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left + 20)
        .attr("x", -margin.top)
        .text("Number of Fights");

      var infoText = d3.select("body").append("div")
        .attr("class", "year-fights-info")
        .style("position", "absolute")
        .style("left", (width / 2) + "px")
        .style("top", (height + 100) + "px")
        .style("text-align", "center");

      var path = svg.append("path")
        .datum(fightsByYear)
        .attr("class", "line")
        .attr("d", line);

      var totalLength = path.node().getTotalLength();

      path.attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .transition()
        .duration(2000)
        .ease("linear")
        .attr("stroke-dashoffset", 0)
        .each("end", function () {
          infoText.text("Animation Complete");
        });

      var drawDuration = 2000;
      var numberOfYears = fightsByYear.length;
      var updateInterval = drawDuration / numberOfYears;

      for (let i = 0; i < numberOfYears; i++) {
        setTimeout(() => {
          var yearData = fightsByYear[i];
          infoText.text("Year: " + yearData.key + ", Fights: " + yearData.values);
        }, i * updateInterval);
      }



      var descriptionParagraph1 = document.createElement("p");
      var descriptionParagraph2 = document.createElement("p");
      var descriptionParagraph3 = document.createElement("p");

      descriptionParagraph1.innerHTML = "<br><br><br><br>This animated line chart visualizes the number of MMA fights over time. The x-axis represents the years, while the y-axis represents the number of fights.";
      descriptionParagraph2.innerHTML = "It uses D3.js to create a dynamic representation of how the number of fights has changed throughout the years.";
      descriptionParagraph3.innerHTML = "The line on the chart animates to reveal the trend in fight occurrences, making it easy to observe any patterns or fluctuations over time.";

      document.body.appendChild(descriptionParagraph1);
      document.body.appendChild(descriptionParagraph2);
      document.body.appendChild(descriptionParagraph3);

    }

    //Code for scatter plot
    function drawStorytellingScatterPlot(data) {
      var margin = { top: 30, right: 20, bottom: 70, left: 70 },
        width = 600 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

      var svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .style("font-size", "24px")
        .text("Wins by Age");

      svg.append("line")
        .attr("x1", 0)
        .attr("x2", width)
        .attr("y1", height)
        .attr("y2", height)
        .style("stroke", "steelblue");

      svg.append("line")
        .attr("x1", 0)
        .attr("x2", 0)
        .attr("y1", 0)
        .attr("y2", height)
        .style("stroke", "steelblue");

      var x = d3.scale.linear()
        .domain([0, d3.max(data, function (d) { return Math.max(d.R_age, d.B_age); })])
        .range([0, width]);

      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .tickSize(5)
        .ticks(5);

      var y = d3.scale.linear()
        .domain([0, d3.max(data, function (d) { return Math.max(d.R_wins, d.B_wins); })])
        .range([height, 0]);

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickSize(5)
        .ticks(5);

      svg.append("line")
        .attr("x1", 0)
        .attr("x2", width)
        .attr("y1", height)
        .attr("y2", height)
        .style("stroke", "steelblue");

      svg.append("line")
        .attr("x1", 0)
        .attr("x2", 0)
        .attr("y1", 0)
        .attr("y2", height)
        .style("stroke", "steelblue");

      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

      svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

      svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", width)
        .attr("y", height + margin.top + 20)
        .text("Fighter Age");

      svg.append("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left + 20)
        .attr("x", -margin.top)
        .text("Number of Wins");

      var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)
        .style("position", "absolute")
        .style("text-align", "center")
        .style("width", "120px")
        .style("height", "28px")
        .style("padding", "2px")
        .style("font", "12px sans-serif")
        .style("background", "lightsteelblue")
        .style("border", "0px")
        .style("border-radius", "8px")
        .style("pointer-events", "none");

      var filteredData = data.filter(d => d.R_age && d.B_age);

      svg.selectAll(".dot-red")
        .data(filteredData)
        .enter().append("circle")
        .attr("class", "dot-red")
        .attr("r", 5)
        .attr("cx", function (d) { return x(d.R_age); })
        .attr("cy", function (d) { return y(d.R_wins); })
        .style("fill", "red")
        .on("mouseover", function (d) {
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);
          tooltip.html("Age: " + d.R_age + "<br/>Wins: " + d.R_wins)
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function (d) {
          tooltip.transition()
            .duration(500)
            .style("opacity", 0);
        });

      svg.selectAll(".dot-blue")
        .data(filteredData)
        .enter().append("circle")
        .attr("class", "dot-blue")
        .attr("r", 5)
        .attr("cx", function (d) { return x(d.B_age); })
        .attr("cy", function (d) { return y(d.B_wins); })
        .style("fill", "blue")
        .on("mouseover", function (d) {
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);
          tooltip.html("Age: " + d.B_age + "<br/>Wins: " + d.B_wins)
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function (d) {
          tooltip.transition()
            .duration(500)
            .style("opacity", 0);
        });

      var descriptionParagraph1 = document.createElement("p");
      var descriptionParagraph2 = document.createElement("p");
      var descriptionParagraph3 = document.createElement("p");

      descriptionParagraph1.textContent = "This scatter plot provides insights into the relationship between the age of fighters and the number of wins they have achieved in MMA fights.";
      descriptionParagraph2.textContent = "It uses D3.js to create a visualization where each point represents a fighter, with their age on the x-axis and the number of wins on the y-axis. The plot helps identify any correlations or trends between fighter age and success in terms of wins.";
      descriptionParagraph3.textContent = "Additionally, it includes tooltips to display detailed information when hovering over data points.";

      document.body.appendChild(descriptionParagraph1);
      document.body.appendChild(descriptionParagraph2);
      document.body.appendChild(descriptionParagraph3);
    }

    //Code for bar chart
    function drawFightOutcomeAnalysis(data) {
      var fightsByStance = d3.nest()
        .key(function (d) { return d['R_Stance']; })
        .rollup(function (v) { return v.length; })
        .entries(data);

      var svg = d3.select("body").append("svg")
        .attr("width", 960)
        .attr("height", 500),
        margin = { top: 20, right: 20, bottom: 30, left: 40 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .style("font-size", "24px")
        .text("Fight Outcome Analysis");

      var x = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1)
        .domain(fightsByStance.map(function (d) { return d.key; }));

      var y = d3.scale.linear()
        .rangeRound([height, 0])
        .domain([0, d3.max(fightsByStance, function (d) { return d.values; })]);

      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

      g.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

      g.append("g")
        .attr("class", "y axis")
        .call(yAxis);

      var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      g.selectAll(".bar")
        .data(fightsByStance)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function (d) { return x(d.key); })
        .attr("y", function (d) { return y(d.values); })
        .attr("height", function (d) { return height - y(d.values); })
        .attr("width", x.rangeBand())
        .on("mouseover", function (d) {
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);
          tooltip.html("Stance: " + d.key + "<br/>Count: " + d.values)
            .style("left", (d3.event.pageX + 5) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function (d) {
          tooltip.transition()
            .duration(500)
            .style("opacity", 0);
        });

      var descriptionParagraph1 = document.createElement("p");
      var descriptionParagraph2 = document.createElement("p");
      var descriptionParagraph3 = document.createElement("p");

      descriptionParagraph1.textContent = "This bar chart offers an analysis of MMA fight outcomes based on the stance of the fighters. It uses D3.js to display the count of fights for each stance category.";
      descriptionParagraph2.textContent = "The x-axis shows different stances, while the y-axis represents the number of fights. ";
      descriptionParagraph3.textContent = "The chart helps viewers understand which stances are more prevalent in MMA fights, providing valuable insights into fighting styles.";

      document.body.appendChild(descriptionParagraph1);
      document.body.appendChild(descriptionParagraph2);
      document.body.appendChild(descriptionParagraph3);
    }

    //Code for map
    function drawMap(data, geocodedData) {
      var width = 1062, height = 600;

      var projection = d3.geo.mercator()
        .scale(160)
        .translate([width / 2, height / 1.4]);

      var path = d3.geo.path().projection(projection);

      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .style("font-size", "24px")
        .text("MMA Knockouts Map");

      //var g = svg.append("g").attr("transform", "translate(0,60)");

      var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      d3.json("world_countries.json", function (json) {
        svg.selectAll(".country")
          .data(json.features)
          .enter().append("path")
          .attr("class", "country")
          .attr("d", path)
          .style("fill", "#add8e6");

        var knockoutsByLocation = d3.nest()
          .key(function (d) { return d.location; })
          .rollup(function (v) { return v.length; })
          .map(data);

        var radiusScale = d3.scale.sqrt()
          .domain([0, d3.max(d3.values(knockoutsByLocation))])
          .range([0, 50]);

        svg.selectAll(".bubble")
          .data(d3.entries(knockoutsByLocation))
          .enter().append("circle")
          .attr("class", "bubble")
          .attr("cx", function (d) {
            var coords = geocodedData.find(loc => loc.original_address === d.key);
            return coords ? projection([coords.lon, coords.lat])[0] : 0;
          })
          .attr("cy", function (d) {
            var coords = geocodedData.find(loc => loc.original_address === d.key);
            return coords ? projection([coords.lon, coords.lat])[1] : 0;
          })
          .attr("r", function (d) { return radiusScale(d.value); })
          .style("fill", "red")
          .style("opacity", 0.6)
          .on("mouseover", function (d) {
            tooltip.transition()
              .duration(200)
              .style("opacity", .9);
            tooltip.html("Location: " + d.key + "<br/>" + "Knockouts: " + d.value)
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function (d) {
            tooltip.transition()
              .duration(500)
              .style("opacity", 0);
          });
      });

      var descriptionParagraph1 = document.createElement("p");
      var descriptionParagraph2 = document.createElement("p");
      var descriptionParagraph3 = document.createElement("p");

      descriptionParagraph1.textContent = "The map visualization shows the geographical distribution of MMA knockouts. It uses D3.js and a world map to display circles at locations where knockouts have occurred.";
      descriptionParagraph2.textContent = "The size of each circle corresponds to the number of knockouts at that location.";
      descriptionParagraph3.textContent = "This map offers a spatial perspective on where MMA knockouts have taken place around the world, making it easy to identify regions with higher knockout rates. Hovering over circles reveals additional information about each location.";

      document.body.appendChild(descriptionParagraph1);
      document.body.appendChild(descriptionParagraph2);
      document.body.appendChild(descriptionParagraph3);
    }



    d3.csv("geocoded_data.csv", function (geocodedData) {
      d3.csv("mmaData.csv", function (error, data) {
        if (error) throw error;

        data.forEach(d => {
          console.log(`R_age: ${d.R_age}, R_wins: ${d.R_wins}, B_age: ${d.B_age}, B_wins: ${d.B_wins}`);
        });
        data.forEach(function (d) {
          d['date'] = new Date(d3.time.format("%d/%m/%Y").parse(d['date']));
        });

        drawTimeSeries(data);
        drawStorytellingScatterPlot(data);
        drawFightOutcomeAnalysis(data);
        drawMap(data, geocodedData);
      });
    });
  </script>
</body>

</html>